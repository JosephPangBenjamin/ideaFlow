// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(cuid())
  username  String   @unique
  phone     String?  @unique
  password  String
  nickname     String?
  avatarUrl    String?  @map("avatar_url")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")
  tokenVersion Int      @default(0) @map("token_version")

  ideas           Idea[]
  tasks           Task[]
  canvases        Canvas[]
  categories      Category[]
  analyticsEvents AnalyticsEvent[]
  notifications   Notification[]

  @@map("users")
}

model Idea {
  id        String   @id @default(cuid())
  content   String
  sources   Json?    // [{ type: 'link'|'image'|'text', url?, title?, thumbnail?, note? }]
  userId    String   @map("user_id")
  isStale   Boolean  @default(false) @map("is_stale")  // 沉底点子标记：7天未操作自动标记
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")
  isPublic    Boolean  @default(false) @map("is_public")
  publicToken String?  @unique @map("public_token")

  user   User    @relation(fields: [userId], references: [id])
  tasks  Task[]
  nodes  CanvasNode[]
  canvas Canvas?  // Canvas V2: 一对一关系

  @@index([userId])
  @@index([createdAt])
  @@index([isStale])  // 沉底筛选优化
  @@map("ideas")
}

model Task {
  id          String     @id @default(cuid())
  title       String
  description String?
  status      TaskStatus @default(todo)
  category    Category?  @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  categoryId  String?    @map("category_id")
  dueDate     DateTime?  @map("due_date")
  ideaId      String?    @map("idea_id")
  userId      String     @map("user_id")
  createdAt   DateTime   @default(now()) @map("created_at")
  updatedAt   DateTime   @updatedAt @map("updated_at")
  deletedAt   DateTime?  @map("deleted_at")
  sources     Json?      // [{ type: 'link'|'image'|'text', url?, title?, thumbnail?, note? }]

  user User  @relation(fields: [userId], references: [id])
  idea Idea? @relation(fields: [ideaId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@index([categoryId])
  @@index([dueDate])
  @@map("tasks")
}

model Category {
  id        String   @id @default(cuid())
  name      String
  color     String?  // hex color
  userId    String   @map("user_id")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user  User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  tasks Task[]

  @@map("categories")
}

enum TaskStatus {
  todo
  in_progress
  done
}

// Canvas V2: 节点类型枚举
enum CanvasNodeType {
  master_idea    // 主想法节点（只读，来自关联的Idea）
  sub_idea       // 子想法节点（可编辑，画布内创建）
  annotation     // 批注节点（纯文字注释）
  image          // 图片节点
  region         // 区域节点（分组容器）
}

model Canvas {
  id        String   @id @default(cuid())
  name      String   @default("未命名画布")
  userId    String   @map("user_id")
  ideaId    String?  @unique @map("idea_id")  // Canvas V2: 关联的核心想法（一对一，可选以支持迁移）
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  isPublic    Boolean  @default(false) @map("is_public")
  publicToken String?  @unique @map("public_token")

  user        User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  idea        Idea?             @relation(fields: [ideaId], references: [id], onDelete: Cascade)
  nodes       CanvasNode[]
  connections CanvasConnection[]

  @@index([userId])
  @@index([ideaId])
  @@map("canvases")
}

model CanvasNode {
  id        String         @id @default(cuid())
  canvasId  String         @map("canvas_id")
  type      CanvasNodeType @default(sub_idea)  // Canvas V2: 节点类型
  ideaId    String?        @map("idea_id")     // 仅 master_idea 类型使用
  x         Float          @default(100)
  y         Float          @default(100)
  width     Float          @default(180)
  height    Float          @default(80)
  content   String?        // 用于 sub_idea/annotation
  imageUrl  String?        @map("image_url")   // Canvas V2: 图片节点URL
  color     String?        // 区域背景颜色
  parentId  String?        @map("parent_id")   // 层级关系（父节点ID）
  style     Json?                              // 样式属性（字体大小、文字颜色、背景图片等）
  createdAt DateTime       @default(now()) @map("created_at")
  updatedAt DateTime       @updatedAt @map("updated_at")

  canvas          Canvas             @relation(fields: [canvasId], references: [id], onDelete: Cascade)
  idea            Idea?              @relation(fields: [ideaId], references: [id], onDelete: SetNull)
  parent          CanvasNode?        @relation("NodeHierarchy", fields: [parentId], references: [id], onDelete: SetNull)
  children        CanvasNode[]       @relation("NodeHierarchy")
  fromConnections CanvasConnection[] @relation("FromNode")
  toConnections   CanvasConnection[] @relation("ToNode")

  @@index([canvasId])
  @@index([ideaId])
  @@index([parentId])
  @@map("canvas_nodes")
}

model CanvasConnection {
  id         String      @id @default(cuid())
  canvasId   String      @map("canvas_id")
  fromNodeId String      @map("from_node_id")
  toNodeId   String      @map("to_node_id")
  label      String?
  createdAt  DateTime    @default(now()) @map("created_at")
  updatedAt  DateTime    @updatedAt @map("updated_at")

  canvas   Canvas     @relation(fields: [canvasId], references: [id], onDelete: Cascade)
  fromNode CanvasNode  @relation("FromNode", fields: [fromNodeId], references: [id], onDelete: Cascade)
  toNode   CanvasNode  @relation("ToNode", fields: [toNodeId], references: [id], onDelete: Cascade)

  @@unique([fromNodeId, toNodeId])
  @@index([canvasId])
  @@index([fromNodeId])
  @@index([toNodeId])
  @@map("canvas_connections")
}

model AnalyticsEvent {
  id        String   @id @default(cuid())
  eventName String   @map("event_name")
  userId    String?  @map("user_id")
  metadata  Json?
  createdAt DateTime @default(now()) @map("created_at")

  user User? @relation(fields: [userId], references: [id])

  @@index([eventName])
  @@index([userId])
  @@index([createdAt])
  @@map("analytics_events")
}

enum NotificationType {
  stale_reminder
  system
}

model Notification {
  id        String           @id @default(cuid())
  userId    String           @map("user_id")
  type      NotificationType
  title     String
  message   String
  data      Json?
  isRead    Boolean          @default(false) @map("is_read")
  createdAt DateTime         @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
  @@map("notifications")
}
